$(function () {
    $("#wizard").steps({
        headerTag: "h4",
        bodyTag: "section",
        transitionEffect: "slide",
        saveState: false,
        rtl: true,
        enableKeyNavigation: false,
        enableAllSteps: true,
        titleTemplate: '<div class="title"><span class="step-number"><p style="visibility: hidden;">#index#</p></span><span class="step-text">#title#</span></div>',
        transitionEffectSpeed: 200,
        startIndex: 0,
        onStepChanging: function (event, currentIndex, newIndex) {
            if (newIndex - currentIndex >= 2) {
                return false
            }
            if (newIndex > currentIndex)
                if (!validateForm(currentIndex)) return false;
            $(".wizard").find("#wizard-t-" + newIndex).parent().prevAll().addClass("checked");
            $(".wizard").find("#wizard-t-" + newIndex).parent().nextAll().removeClass("checked");
            if (newIndex === 0) {
                $("#info").html("اطلاعات پایه شخصی");
                $("#sideImage").attr("src", "static/wizard/images/1.png");
                $("#sideImage").addClass("fade-in");
                $("body").css("background-color", "rgba(182,218,236,0.3)");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            // if (newIndex === 2) {
            //     $("#info").html("پژوهش، خلاقیت و نوآوری");
            //     $("#sideImage").attr("src", "static/wizard/images/2.png");
            //     $("#sideImage").addClass("fade-in");
            //     $("body").css("background-color", "rgba(224,224,225,0.3)");
            //     $(".actions.clearfix").css({display: "", "justify-content": ""});
            //     $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            // }
            if (newIndex === 1) {
                $("#info").html("سوابق شغلی و<br/> توانمندی های<br/> حرفه ای");
                $("#sideImage").attr("src", "static/wizard/images/11.png");
                $("#sideImage").addClass("fade-in");
                $("body").css("background-color", "rgba(182,218,236,0.3)");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 2) {
                $("#info").html("سوابق شغلی و<br/> توانمندی های <br/>حرفه ای");
                $("#sideImage").attr("src", "static/wizard/images/4.png");
                $("#sideImage").addClass("fade-in");
                $("body").css("background-color", "rgba(182,218,236,0.3)");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})


            }
            if (newIndex === 3) {
                $("#info").html("هویتی، عمومی، اثرگذاری و توانمندی های تحلیلی");
                $("#sideImage").attr("src", "static/wizard/images/5.png");
                $("#sideImage").addClass("fade-in");
                $("body").css("background-color", "rgba(224,224,225,0.3)");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 4) {
                $("#info").html("هویتی، عمومی، اثرگذاری و توانمندی های تحلیلی");
                $("#sideImage").attr("src", "static/wizard/images/6.png");
                $("#sideImage").addClass("fade-in");
                $("body").css("background-color", "rgba(224,224,225,0.3)");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 5) {
                $("#info").html("هویتی، عمومی، اثرگذاری و توانمندی های تحلیلی");
                $("#sideImage").attr("src", "static/wizard/images/7.png");
                $("#sideImage").addClass("fade-in");
                $("body").css("background-color", "rgba(224,224,225,0.3)");
                // $(".actions.clearfix").css({display: "", "justify-content": ""});
                // $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
                if (screen.width > 800) {
                    $(".actions.clearfix").css({display: "flex", "justify-content": "flex-end"});
                    $(".actions ul").css({"margin-top": "-130px"});
                    // $(".actions ul").css({"flex-direction": "column-reverse", "margin-top": "-210px"});
                    // $(".actions ul>li:first").css({"margin-bottom": "55px"})
                    $(".actions ul>li:first").css({"margin-bottom": "55px", 'margin-left': '55px'})
                }
            }
            if (newIndex === 6) {
                $("body").css("background-color", "rgba(224,224,225,0.3)");
                $("#sideImage").attr("src", "static/wizard/images/8.png");
                $("#info").html("هویتی، عمومی، اثرگذاری و توانمندی های تحلیلی");
                $("#sideImage").addClass("fade-in");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 7) {
                $("body").css("background-color", "rgba(224,224,225,0.3)");
                $("#sideImage").attr("src", "static/wizard/images/9.png");
                $("#info").html("هویتی، عمومی، اثرگذاری و توانمندی های تحلیلی");
                $("#sideImage").addClass("fade-in");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 8) {
                $("body").css("background-color", "#fff");
                $("#sideImage").attr("src", "static/wizard/images/10.png");
                $("#info").html("روانشناختی کار");
                $("#sideImage").addClass("fade-in");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 9) {
                $("body").css("background-color", "#fff");
                $("#sideImage").attr("src", "static/wizard/images/13.png");
                $("#info").html("روانشناختی کار");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            if (newIndex === 10) {
                $("body").css("background-color", "#fff");
                $("#sideImage").attr("src", "static/wizard/images/12.png");
                $("#info").html("ما در آرین سعید");
                $(".actions.clearfix").css({display: "", "justify-content": ""});
                $(".actions ul").css({"flex-direction": "", "margin-top": "30px"})
            }
            return true
        },
        onFinishing: function (event, currentIndex) {
            if (!validateForm(currentIndex)) return false;
            return true
        },
        onFinished: function (event, currentIndex) {
            let str = "";
            let obj = $("#sortlist").find("li");
            var isTouch = (('ontouchstart' in window) || (navigator.msMaxTouchPoints > 0));
            if (isTouch) {
                str = $("#se1").val() + "-" + $("#se2").val() + "-" + $("#se3").val() + "-" + $("#se4").val()

            } else {
                for (var i = 0; i < 5; i++)
                    str += obj.eq(i).find("p").text() + "-";
            }
            var data = {
                fullname: $("#fullname").val(),
                company: $("#company").val(),
                registerDate: $("#registerDate").val(),
                fieldstudy: $("#fieldstudy").val(),
                Grade: $("#Grade").val(),
                univercity: $("#univercity").val(),
                g1: $('input[name="g1"]:checked').val(),
                g2: $('input[name="g2"]:checked').val(),
                languageint: $("#languageint").val(),
                language: $("#language").val(),
                g3: $('input[name="g3"]:checked').val(),
                foregin: $('input[name="choicecountry"]:checked').next().text() + '*' + $("#foregin1").val() + '*' + $("#foregin2").val(),
                g4: $('input[name="g4"]:checked').val(),
                sport: $("#sport").val(),
                freetime: $("#freetime").val(),
                book: $("#book").val(),
                news: $("#news").val(),
                work: $("#work").val(),
                ngo: $("#ngo").val(),
                goodwork: $("#goodwork").val(),
                outfactory: $("#outfactory").val(),
                MBTI: $('input[name="mbti"]:checked').val(),
                route: $('input[name="choice"]:checked').next().text() + '*' + $("#who").val() + '*' + $("#why").val(),
                sort: str,
                reasons: $("#reasons").val() + '-' + $("#reasons1").val() + '-' + $("#reasons2").val(),
                description: $("#description").val() + '-' + $("#description1").val() + '-' + $("#description2").val() + '-' + $("#description3").val() + '-' + $("#description4").val(),
                pointwork: $("#pointwork").val() + '-' + $("#pointwork1").val() + '-' + $("#pointwork2").val(),
                process: $("#process").val(),
                lie: $("#lie").val(),
                g10: $('input[name="g10"]:checked').val(),
                goodday: $("#goodday").val(),
                hard: $("#hard").val(),
                hard2: $("#hard2").val(),
                age: $("#age").val(),
                gender: $("#gender").val(),
                knowlage: $("#knowlage").val(),
                personality: $("#personality").val(),


                success: $("#success").val(),
                learning: $("#learning").val(),
                money: $("#money").val(),
                g15: $('input[name="g15"]:checked').val(),


                creative: $("#creative").val(),
                leader: $("#leader").val(),
                like: $("#like").val(),
                dislike: $("#dislike").val(),

                entrepreneur: $("#entrepreneur").val(),
                star: $("#star").val(),
                broke: $("#broke").val(),
                g17: $('input[name="g17"]:checked').next().text(),
                g18: $('input[name="g18"]:checked').next().text(),
                is_read: false,
                suggest: $("#suggest").val(),
                area: $("#area").val(),
                newarea: $("#newarea").val(),
                solution: $("#solution").val(),
                jobs: json()
            };
            $("#loader").show();
            $.ajax({
                url: "/survey/create/",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                beforeSend: function (xhr) {
                    // xhr.setRequestHeader('X-CSRFToken', );
                },
                success: function (response) {
                    localStorage.clear();
                    window.location.href = "/complete"
                },
                error: function (jqXHR, exception) {
                    $.notify({icon: "add_alert", message: JSON.parse(jqXHR.responseText).error}, {
                        animate: false,
                        hideDuration: 0,
                        type: "rose",
                        timer: 100,
                        placement: {from: "top", align: "right"}
                    })
                },
                complete: function (e) {
                    $("#loader").fadeOut("slow");
                }
            })
        },
        onStepChanged: function (event, currentIndex, priorIndex) {
            $("#sideImage").removeClass("fade-in");
            localStorage.setItem("fullname", $("#fullname").val());
            localStorage.setItem("company", $("#company").val());
            localStorage.setItem("registerDate", $("#registerDate").val());
            localStorage.setItem("fieldstudy", $("#fieldstudy").val());
            localStorage.setItem("Grade", $("#Grade").val());
            localStorage.setItem("univercity", $("#univercity").val());

            localStorage.setItem("json", JSON.stringify(json()));

            localStorage.setItem("g1", $('input[name="g1"]:checked').val());
            localStorage.setItem("g2", $('input[name="g2"]:checked').val());
            localStorage.setItem("languageint", $("#languageint").val());
            localStorage.setItem("language", $("#language").val());
            localStorage.setItem("g3", $('input[name="g3"]:checked').val());
            localStorage.setItem("foreign", $('input[name="choicecountry"]:checked').val());
            localStorage.setItem("foregin1", $("#foregin1").val());
            localStorage.setItem("foregin2", $("#foregin2").val());


            localStorage.setItem("g4", $('input[name="g4"]:checked').val());
            localStorage.setItem("sport", $("#sport").val());
            localStorage.setItem("freetime", $("#freetime").val());
            localStorage.setItem("book", $("#book").val());
            localStorage.setItem("news", $("#news").val());
            localStorage.setItem("goodwork", $("#goodwork").val());
            localStorage.setItem("work", $("#work").val());
            localStorage.setItem("ngo", $("#ngo").val());
            localStorage.setItem("outfactory", $("#outfactory").val());


            localStorage.setItem("mbti", $('input[name="mbti"]:checked').val());

            localStorage.setItem("choice", $('input[name="choice"]:checked').val());
            localStorage.setItem("who", $("#who").val());
            localStorage.setItem("why", $("#why").val());
            localStorage.setItem("sort", JSON.stringify(sortlist()));
            localStorage.setItem("description", $("#description").val());
            localStorage.setItem("description1", $("#description1").val());
            localStorage.setItem("description2", $("#description2").val());
            localStorage.setItem("description3", $("#description3").val());
            localStorage.setItem("description4", $("#description4").val());
            localStorage.setItem("pointwork", $("#pointwork").val());
            localStorage.setItem("pointwork1", $("#pointwork1").val());
            localStorage.setItem("pointwork2", $("#pointwork2").val());
            localStorage.setItem("reasons", $("#reasons").val());
            localStorage.setItem("reasons1", $("#reasons1").val());
            localStorage.setItem("reasons2", $("#reasons2").val());
            localStorage.setItem("process", $("#process").val());
            localStorage.setItem("lie", $("#lie").val());
            localStorage.setItem("g10", $('input[name="g10"]:checked').val());


            localStorage.setItem("goodday", $("#goodday").val());
            localStorage.setItem("hard", $("#hard").val());
            localStorage.setItem("hard2", $("#hard2").val());
            localStorage.setItem("age", $("#age").val());
            localStorage.setItem("gender", $("#gender").val());
            localStorage.setItem("knowlage", $("#knowlage").val());
            localStorage.setItem("personality", $("#personality").val());


            localStorage.setItem("success", $("#success").val());
            localStorage.setItem("money", $("#money").val());
            localStorage.setItem("g15", $('input[name="g15"]:checked').val());
            localStorage.setItem("learning", $("#learning").val());


            localStorage.setItem("creative", $("#creative").val());
            localStorage.setItem("leader", $("#leader").val());
            localStorage.setItem("like", $("#like").val());
            localStorage.setItem("dislike", $("#dislike").val());


            localStorage.setItem("entrepreneur", $("#entrepreneur").val());
            localStorage.setItem("star", $("#star").val());
            localStorage.setItem("broke", $("#broke").val());
            localStorage.setItem("g17", $('input[name="g17"]:checked').val());
            localStorage.setItem("g18", $('input[name="g18"]:checked').val());

            localStorage.setItem("se1", $("#se1").val());
            localStorage.setItem("se2", $("#se2").val());
            localStorage.setItem("se3", $("#se3").val());
            localStorage.setItem("se4", $("#se4").val());
            return true
        },
        labels: {finish: "ارسال اطلاعات", next: "بعدی", previous: "قبلی"}
    });
    $("input").on("input", function (e) {
        $(this).css("box-shadow", "")
    });
    $("textarea").on("input", function (e) {
        $(this).css("box-shadow", "")
    });

    function validateForm(index) {
        var date = /^[0-9]{4}\/([1-9]|[0-1][0-2])$/i;
        var ch, y, i, valid = true;
        var elements = $(".tabc");
        y = elements.eq(index).find("input");
        ch = elements.eq(index).find("textarea");
        for (i = 0; i < y.length; i++) {
            if (index != 1) {
                if (y[i].value == "" || $(y[i]).val().length > 250) {
                    $(y[i]).css("box-shadow", "3px 3px 4px 0 rgba(156, 39, 176, 0.15)");
                    valid = false
                }
            }
        }
        for (i = 0; i < ch.length; i++) {
            if (ch[i].value == "") {
                $(ch[i]).css("box-shadow", "3px 3px 4px 0 rgba(156, 39, 176, 0.15)");
                valid = false
            }
        }
        switch (index) {
            case 0: {
                if ($("#Grade").prop("selectedIndex") == 0 || $("#company").prop("selectedIndex") == 0 || !date.test($("#registerDate").val())) valid = false
            }
                break;
            case 1: {
                if ($("#tbody").find("tr").length == 0) valid = false
            }
                break;
            case 5: {
                var isTouch = (('ontouchstart' in window) || (navigator.msMaxTouchPoints > 0));
                if (isTouch)
                    if ($("#se1").prop("selectedIndex") == 0 || $("#se2").prop("selectedIndex") == 0 || $("#se3").prop("selectedIndex") == 0 || $("#se4").prop("selectedIndex") == 0) valid = false
            }
                break;
            case 6: {
                if ($("#age").prop("selectedIndex") == 0 || $("#gender").prop("selectedIndex") == 0 || $("#knowlage").prop("selectedIndex") == 0) valid = false
            }
        }
        if (valid == false) {
            $.notify({icon: "add_alert", message: "اطلاعات را بررسی بفرمایید"}, {
                animate: false,
                hideDuration: 0,
                type: "rose",
                timer: 100,
                placement: {from: "top", align: "left"}
            })
        }
        // return valid;
        return true;
    }

    $(".forward").click(function () {
        $("#wizard").steps("next")
    });
    $(".backward").click(function () {
        $("#wizard").steps("previous")
    })
});